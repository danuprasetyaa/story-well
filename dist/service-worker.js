const APP_CACHE="app-shell-v2",DATA_CACHE="data-cache-v1",APP_SHELL=["/","/index.html","/bundle.js","/styles/style.css","/manifest.webmanifest","/icons/icon-192.png","/icons/icon-512.png","/icons/badge-72.png"];function idbOpen(){return new Promise((t,e)=>{const n=indexedDB.open("app-db",1);n.onupgradeneeded=()=>{const t=n.result;t.objectStoreNames.contains("items")||t.createObjectStore("items",{keyPath:"id"}),t.objectStoreNames.contains("pending")||t.createObjectStore("pending",{keyPath:"tempId"}),t.objectStoreNames.contains("auth")||t.createObjectStore("auth",{keyPath:"key"})},n.onsuccess=()=>t(n.result),n.onerror=()=>e(n.error)})}async function idbGetAll(t){const e=await idbOpen();return new Promise((n,i)=>{const a=e.transaction(t,"readonly").objectStore(t).getAll();a.onsuccess=()=>n(a.result),a.onerror=()=>i(a.error)})}async function idbDelete(t,e){const n=await idbOpen();return new Promise((i,a)=>{const o=n.transaction(t,"readwrite");o.objectStore(t).delete(e),o.oncomplete=()=>i(),o.onerror=()=>a(o.error)})}async function syncPending(){const t=await idbGetAll("pending");if(!t.length)return;const[e]=await idbGetAll("auth"),n=e?.value||"";for(const e of t)try{if(!(await fetch("https://story-api.dicoding.dev/v1/stories",{method:"POST",headers:{Authorization:`Bearer ${n}`},body:e.formData})).ok)continue;await idbDelete("pending",e.tempId),self.registration.showNotification("Sinkronisasi Berhasil",{body:e.description||"Cerita tersimpan."})}catch{}}self.addEventListener("install",t=>{t.waitUntil(caches.open(APP_CACHE).then(t=>t.addAll(APP_SHELL.map(t=>new Request(t,{cache:"reload"}))))),self.skipWaiting()}),self.addEventListener("activate",t=>{t.waitUntil(caches.keys().then(t=>Promise.all(t.map(t=>{if(![APP_CACHE,DATA_CACHE].includes(t))return caches.delete(t)})))),self.clients.claim()}),self.addEventListener("fetch",t=>{const e=t.request,n=new URL(e.url);"GET"===e.method&&("localhost"===n.hostname&&(n.pathname.includes("hot-update")||n.pathname.startsWith("/ws")||n.pathname.endsWith("/sockjs-node"))||("navigate"!==e.mode?n.origin===location.origin&&APP_SHELL.includes(n.pathname)||"story-api.dicoding.dev"!==n.hostname?t.respondWith(caches.match(e).then(t=>t||fetch(e))):t.respondWith((async()=>{try{const t=await fetch(e);return(await caches.open(DATA_CACHE)).put(e,t.clone()),t}catch{return await caches.match(e)||new Response(JSON.stringify({offline:!0,listStory:[]}),{headers:{"Content-Type":"application/json"}})}})()):t.respondWith(caches.match("/index.html").then(t=>t||fetch("/index.html")))))}),self.addEventListener("push",t=>{t.waitUntil((async()=>{if("undefined"!=typeof Notification&&"granted"!==Notification.permission)return;let e="Story Well",n="Ada cerita baru. Lihat detailnya!",i="./icons/icon-192.png",a="/#/",o="story";if(t.data)try{const s=t.data.json();e=s.title??e,n=s.body??n,i=s.icon??i,a=s.url??a,o=s.id?`story-${s.id}`:o}catch{n=await t.data.text()}return self.registration.showNotification(e,{body:n,icon:i,badge:"./icons/badge-72.png",tag:o,data:{url:a},actions:[{action:"open",title:"Buka"},{action:"dismiss",title:"Tutup"}]})})())}),self.addEventListener("notificationclick",t=>{if(t.notification.close(),"dismiss"===t.action)return;const e=t.notification.data?.url||"/#/";t.waitUntil((async()=>{const t=await clients.matchAll({type:"window",includeUncontrolled:!0});for(const n of t){try{n.navigate&&n.navigate(e)}catch{}if("focus"in n)return n.focus()}return clients.openWindow(e)})())}),self.addEventListener("sync",t=>{"sync-pending"===t.tag&&t.waitUntil(syncPending())});